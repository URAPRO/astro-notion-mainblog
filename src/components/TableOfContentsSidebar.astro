---
import type * as interfaces from '../lib/interfaces.ts';
import type { RichText } from '../lib/interfaces.ts';
import { slugify } from '../lib/blog-helpers.ts';

export interface Props {
  headings: interfaces.Block[];
}

const { headings } = Astro.props;

// RichText[] からプレーンテキストを抽出するヘルパー関数
const extractPlainText = (richTexts: RichText[] | undefined): string => {
  if (!richTexts) return '';
  return richTexts.map(rt => rt.PlainText).join('');
};
---

{headings && headings.length > 0 && (
  <nav class="toc-sidebar" aria-labelledby="toc-heading">
    <h2 id="toc-heading" class="toc-title">目次</h2>
    <ul class="toc-list">
      {headings.map(heading => {
        let text = '';
        let level = 0;
        let id = '';

        if (heading.Type === 'heading_1' && heading.Heading1) {
          text = extractPlainText(heading.Heading1.RichTexts);
          level = 1;
        } else if (heading.Type === 'heading_2' && heading.Heading2) {
          text = extractPlainText(heading.Heading2.RichTexts);
          level = 2;
        } else if (heading.Type === 'heading_3' && heading.Heading3) {
          text = extractPlainText(heading.Heading3.RichTexts);
          level = 3;
        }
        if (text) {
          id = slugify(text); // テキストをslugifyしてIDに
        }

        return text ? (
          <li class={`toc-item toc-item-level-${level}`}>
            <a href={`#${id}`}>{text}</a>
          </li>
        ) : null;
      })}
    </ul>
  </nav>
)}

<style>
  .toc-sidebar {
    margin: 0;
    padding: 0.6rem 0.75rem;
    background: linear-gradient(135deg, #f8fafc, #eef2ff);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
  }
  .toc-title {
    font-size: 1rem;
    font-weight: 800;
    color: #0f172a;
    margin: 0 0 0.6rem;
    padding-bottom: 0.4rem;
    border-bottom: 1px solid #e2e8f0;
    letter-spacing: 0.01em;
  }
  .toc-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
    font-size: 0.95rem;
  }
  .toc-item {
    margin-bottom: 0.45rem;
    line-height: 1.5;
  }
  .toc-item a {
    text-decoration: none;
    color: #334155;
    padding: 0.25rem 0.35rem;
    border-radius: 8px;
    display: inline-block;
    transition: color 0.2s ease, background 0.2s ease;
  }
  .toc-item a:hover {
    color: #1d4ed8;
    background: rgba(37, 99, 235, 0.08);
  }
  .toc-item-level-1 {
    font-weight: 700;
  }
  .toc-item-level-2 {
    padding-left: 0.75em;
  }
  .toc-item-level-3 {
    padding-left: 1.5em;
  }
</style>