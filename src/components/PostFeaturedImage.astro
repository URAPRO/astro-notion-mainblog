---
import type { Post } from '../lib/interfaces.ts'
import { filePath } from '../lib/blog-helpers'
export interface Props {
  post: Post
  enableLink: boolean
  altText?: string // Optional custom alt text, defaults to post title
}

const { post, altText } = Astro.props

// alt属性はカスタムテキストまたは記事タイトルを使用
const imageAltText = altText || post.Title || 'アイキャッチ画像'

let imageUrl = ''
let webpUrl = '' // Large: 800px
let mediumUrl = '' // Medium: 400px
let smallUrl = '' // Small: 200px

if (post.FeaturedImage && post.FeaturedImage.Url) {
  if (import.meta.env.DEV) {
    imageUrl = post.FeaturedImage.Url
  } else {
    const originalPath = filePath(new URL(post.FeaturedImage.Url))
    imageUrl = originalPath

    // 各サイズのWebPパスを生成
    const pathParts = originalPath.split('.')
    const ext = pathParts.pop()
    const basePath = pathParts.join('.')

    // WebPファイルのパス（元がWebP以外の場合も含む）
    webpUrl = `${basePath}.webp`
    mediumUrl = `${basePath}-md.webp`
    smallUrl = `${basePath}-sm.webp`
  }
}

// srcset文字列を生成
const srcsetValue = [smallUrl, mediumUrl, webpUrl]
  .filter(Boolean)
  .map((url, i) => {
    const widths = [200, 400, 800]
    return `${url} ${widths[i]}w`
  })
  .join(', ')
---

{
  imageUrl && (
    <div class="post-featured-image">
      <picture>
        {srcsetValue && (
          <source
            srcset={srcsetValue}
            sizes="(max-width: 480px) 400px, (max-width: 768px) 600px, 800px"
            type="image/webp"
          />
        )}
        <img
          src={webpUrl || imageUrl}
          alt={imageAltText}
          loading="lazy"
          decoding="async"
        />
      </picture>
      <noscript>
        <img src={imageUrl} alt={imageAltText} />
      </noscript>
    </div>
  )
}

<style>
  .post-featured-image {
    padding: 0;
    overflow: hidden;
    aspect-ratio: 16 / 9;
    background: linear-gradient(135deg, #f5f0e8 0%, #ede5da 100%);
    width: 100%;
    height: 100%;
    position: relative;
  }

  .post-featured-image picture,
  .post-featured-image img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .post-featured-image img {
    transition:
      transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.3s ease-in-out;
    /* 縮小表示時の品質向上 */
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
</style>
