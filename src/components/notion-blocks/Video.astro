---
import * as interfaces from '../../lib/interfaces.ts'
import { isYouTubeURL, parseYouTubeVideoId, filePath } from '../../lib/blog-helpers.ts'
import Caption from './Caption.astro'

export interface Props {
  block: interfaces.Block
}

const { block } = Astro.props

let url: URL | null = null
let videoSrc = ''
const videoUrl = block.Video?.External?.Url || block.Video?.File?.Url

if (videoUrl) {
  try {
    url = new URL(videoUrl)
    // Notionファイルの場合はローカルパスに変換
    if (block.Video?.File?.Url) {
      videoSrc = filePath(url)
    } else {
      videoSrc = videoUrl
    }
  } catch (err) {
    console.log('Invalid video URL:', videoUrl, err)
  }
}

const isYouTube = url ? isYouTubeURL(url) : false
const isDirectVideo = !isYouTube && videoSrc
---

{url ? (
  <div class="video">
    <div>
      {isYouTube && (
        <iframe
          src={`https://www.youtube.com/embed/${parseYouTubeVideoId(url)}`}
          title="YouTube video player"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
        />
      )}
      {isDirectVideo && (
        <video controls playsinline preload="metadata">
          <source src={videoSrc} />
          お使いのブラウザは動画の再生に対応していません。
        </video>
      )}
    </div>
    <Caption richTexts={block.Video?.Caption} />
  </div>
) : null}

<style>
  .video div:first-child {
    width: 100%;
  }
  .video div:first-child iframe,
  .video div:first-child video {
    width: 100%;
    max-width: 100%;
    height: auto;
  }
  .video div:first-child iframe {
    height: 340px;
    border: none;
  }
  @media (max-width: 640px) {
    .video div:first-child iframe {
      height: 220px;
    }
  }
</style>
