---
import * as interfaces from '../../lib/interfaces.ts'
import { buildHeadingId } from '../../lib/blog-helpers.ts'
import RichText from './RichText.astro'
import NotionBlocks from '../NotionBlocks.astro'

export interface Props {
  block: interfaces.Block
  headings: interfaces.Block[]
  level: 1 | 2 | 3
}

const { block, headings, level } = Astro.props

// レベルに応じたHeadingデータを取得
const headingData =
  level === 1 ? block.Heading1 : level === 2 ? block.Heading2 : block.Heading3

const id = headingData ? buildHeadingId(headingData) : ''

// レベルに応じたスタイル設定
const styleConfig = {
  1: {
    fontSize: '1.8rem',
    mobileFontSize: '1.3rem',
    margin: '1.1em',
    toggleMargin: '2rem',
    mobileToggleMargin: '1.4rem',
  },
  2: {
    fontSize: '1.5rem',
    mobileFontSize: '1.2rem',
    margin: '1em',
    toggleMargin: '1.6rem',
    mobileToggleMargin: '1.2rem',
  },
  3: {
    fontSize: '1.25rem',
    mobileFontSize: '1.1rem',
    margin: '0.9em',
    toggleMargin: '1.2rem',
    mobileToggleMargin: '1.1rem',
  },
} as const

const config = styleConfig[level]

// HTMLタグはh3, h4, h5に対応（Notionのh1→h3, h2→h4, h3→h5）
const tagName = level === 1 ? 'h3' : level === 2 ? 'h4' : 'h5'
---

{
  headingData?.IsToggleable ? (
    <details
      class={`toggle toggle-${level}`}
      style={`--toggle-margin: ${config.toggleMargin}; --mobile-toggle-margin: ${config.mobileToggleMargin}`}
    >
      <summary>
        <a href={`#${id}`} id={id}>
          {tagName === 'h3' && (
            <h3
              class={`heading heading-${level}`}
              style={`--font-size: ${config.fontSize}; --mobile-font-size: ${config.mobileFontSize}; --margin: ${config.margin}`}
            >
              {headingData.RichTexts.map((richText: interfaces.RichText) => (
                <RichText richText={richText} />
              ))}
            </h3>
          )}
          {tagName === 'h4' && (
            <h4
              class={`heading heading-${level}`}
              style={`--font-size: ${config.fontSize}; --mobile-font-size: ${config.mobileFontSize}; --margin: ${config.margin}`}
            >
              {headingData.RichTexts.map((richText: interfaces.RichText) => (
                <RichText richText={richText} />
              ))}
            </h4>
          )}
          {tagName === 'h5' && (
            <h5
              class={`heading heading-${level}`}
              style={`--font-size: ${config.fontSize}; --mobile-font-size: ${config.mobileFontSize}; --margin: ${config.margin}`}
            >
              {headingData.RichTexts.map((richText: interfaces.RichText) => (
                <RichText richText={richText} />
              ))}
            </h5>
          )}
        </a>
      </summary>
      <div>
        {headingData.Children && (
          <NotionBlocks blocks={headingData.Children} headings={headings} />
        )}
      </div>
    </details>
  ) : (
    <a href={`#${id}`} id={id}>
      {tagName === 'h3' && (
        <h3
          class={`heading heading-${level}`}
          style={`--font-size: ${config.fontSize}; --mobile-font-size: ${config.mobileFontSize}; --margin: ${config.margin}`}
        >
          {headingData?.RichTexts.map((richText: interfaces.RichText) => (
            <RichText richText={richText} />
          ))}
        </h3>
      )}
      {tagName === 'h4' && (
        <h4
          class={`heading heading-${level}`}
          style={`--font-size: ${config.fontSize}; --mobile-font-size: ${config.mobileFontSize}; --margin: ${config.margin}`}
        >
          {headingData?.RichTexts.map((richText: interfaces.RichText) => (
            <RichText richText={richText} />
          ))}
        </h4>
      )}
      {tagName === 'h5' && (
        <h5
          class={`heading heading-${level}`}
          style={`--font-size: ${config.fontSize}; --mobile-font-size: ${config.mobileFontSize}; --margin: ${config.margin}`}
        >
          {headingData?.RichTexts.map((richText: interfaces.RichText) => (
            <RichText richText={richText} />
          ))}
        </h5>
      )}
    </a>
  )
}

<style>
  .heading {
    margin: var(--margin) 0 0.3em;
    color: var(--fg);
    font-size: var(--font-size);
  }

  @media (max-width: 640px) {
    .heading {
      font-size: var(--mobile-font-size);
    }
  }

  .toggle {
    margin: var(--toggle-margin) 0 0;
  }

  @media (max-width: 640px) {
    .toggle {
      margin: var(--mobile-toggle-margin) 0 0;
    }
  }

  .toggle > summary {
    cursor: pointer;
  }

  .toggle > summary > a {
    display: inline;
  }

  .toggle > summary > a > .heading {
    display: inline;
  }

  .toggle > div {
    margin-left: 1em;
  }
</style>
